import React, { useEffect, useState } from 'react';
import { Modal, Form, Input, Select, DatePicker, message } from 'antd';
import dayjs from 'dayjs';
import api from '../../services/api';
import { Vulnerability } from '../../types';
import FieldLabelWithHelp from '../../components/common/FieldLabelWithHelp';

interface VulnerabilityFormProps {
  visible: boolean;
  record: Vulnerability | null;
  onClose: () => void;
  onSuccess: () => void;
  apiPath: string;
}

export default function VulnerabilityForm({ visible, record, onClose, onSuccess, apiPath }: VulnerabilityFormProps) {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [assets, setAssets] = useState<Array<{ value: string; label: string }>>([]);

  useEffect(() => {
    if (!visible) return;

    api.get('/assets', { params: { page: 1, limit: 200 } })
      .then((res) => {
        const options = (res.data.data || []).map((a: any) => ({
          value: a.id,
          label: `${a.asset_code} — ${a.name}`,
        }));
        setAssets(options);
      })
      .catch(() => setAssets([]));

    if (record) {
      form.setFieldsValue({
        ...record,
        detection_date: record.detection_date ? dayjs(record.detection_date) : undefined,
        planned_fix_date: (record as any).planned_fix_date ? dayjs((record as any).planned_fix_date) : undefined,
      });
    } else {
      form.resetFields();
      form.setFieldsValue({
        type: 'boşluq',
        severity_internal: 'orta',
        detection_method: 'audit',
        exploitation_status: 'istifadə_olunmayıb',
        status: 'açıq',
        detection_date: dayjs(),
      });
    }
  }, [visible, record, form]);

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      setLoading(true);

      const payload = {
        ...values,
        detection_date: values.detection_date?.format('YYYY-MM-DD'),
        planned_fix_date: values.planned_fix_date ? values.planned_fix_date.format('YYYY-MM-DD') : null,
      };

      if (record) {
        await api.put(`${apiPath}/${record.id}`, payload);
        message.success('Boşluq yeniləndi');
      } else {
        await api.post(apiPath, payload);
        message.success('Boşluq yaradıldı');
      }
      onSuccess();
    } catch (error) {
      if ((error as any)?.errorFields) return;
      message.error('Yadda saxlama zamanı xəta');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Modal
      title={record ? 'Boşluğu redaktə et' : 'Yeni boşluq'}
      open={visible}
      onCancel={onClose}
      onOk={handleSubmit}
      confirmLoading={loading}
      width={760}
      destroyOnClose
    >
      <Form form={form} layout="vertical">
        <Form.Item name="name" label="Ad" rules={[{ required: true }]}> 
          <Input />
        </Form.Item>

        <Form.Item name="type" label={<FieldLabelWithHelp fieldKey="vulnerabilities.type" label="Növ" required />} rules={[{ required: true }]}> 
          <Select options={[
            { value: 'boşluq', label: 'boşluq' },
            { value: 'nəzarətsizlik', label: 'nəzarətsizlik' },
            { value: 'zəiflik', label: 'zəiflik' },
            { value: 'uyğunsuzluq', label: 'uyğunsuzluq' },
          ]} />
        </Form.Item>

        <Form.Item name="asset_id" label={<FieldLabelWithHelp fieldKey="vulnerabilities.asset_id" label="Aktiv" />}>
          <Select allowClear options={assets} />
        </Form.Item>

        <Form.Item name="cve_ref" label="CVE ref">
          <Input placeholder="CVE-2026-0001" />
        </Form.Item>

        <Form.Item name="severity_internal" label={<FieldLabelWithHelp fieldKey="vulnerabilities.severity_internal" label="Daxili ciddilik" required />} rules={[{ required: true }]}> 
          <Select options={[
            { value: 'az', label: 'az' },
            { value: 'orta', label: 'orta' },
            { value: 'yüksək', label: 'yüksək' },
            { value: 'çox_yüksək', label: 'çox_yüksək' },
            { value: 'kritik', label: 'kritik' },
            { value: 'fövqəladə', label: 'fövqəladə' },
          ]} />
        </Form.Item>

        <Form.Item name="detection_method" label={<FieldLabelWithHelp fieldKey="vulnerabilities.detection_method" label="Aşkarlanma üsulu" required />} rules={[{ required: true }]}> 
          <Select options={[
            { value: 'audit', label: 'audit' },
            { value: 'pentest', label: 'pentest' },
            { value: 'özqiymətləndirmə', label: 'özqiymətləndirmə' },
            { value: 'dxeit_bildirişi', label: 'dxeit_bildirişi' },
            { value: 'insident', label: 'insident' },
          ]} />
        </Form.Item>

        <Form.Item name="exploitation_status" label={<FieldLabelWithHelp fieldKey="vulnerabilities.exploitation_status" label="İstismar statusu" required />} rules={[{ required: true }]}> 
          <Select options={[
            { value: 'istifadə_olunmayıb', label: 'istifadə_olunmayıb' },
            { value: 'istifadə_cəhdi', label: 'istifadə_cəhdi' },
            { value: 'istifadə_edilib', label: 'istifadə_edilib' },
          ]} />
        </Form.Item>

        <Form.Item name="status" label={<FieldLabelWithHelp fieldKey="vulnerabilities.status" label="Status" required />} rules={[{ required: true }]}> 
          <Select options={[
            { value: 'açıq', label: 'açıq' },
            { value: 'işdə', label: 'işdə' },
            { value: 'həll_edilib', label: 'həll_edilib' },
            { value: 'risk_kimi_qəbul_edilib', label: 'risk_kimi_qəbul_edilib' },
          ]} />
        </Form.Item>

        <Form.Item name="detection_date" label="Aşkarlanma tarixi" rules={[{ required: true }]}> 
          <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
        </Form.Item>

        <Form.Item name="planned_fix_date" label="Planlanan fix tarixi">
          <DatePicker style={{ width: '100%' }} format="YYYY-MM-DD" />
        </Form.Item>
      </Form>
    </Modal>
  );
}
